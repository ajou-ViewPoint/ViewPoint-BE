<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>ALIKE í›„ì›í•˜ê¸° (í…ŒìŠ¤íŠ¸)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://js.tosspayments.com/v1"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background:#f7f8fc; padding:30px; }
        .container { max-width:480px; margin:auto; background:white; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,0.08); padding:24px; }
        h1 { text-align:center; margin-bottom:16px; }
        label { display:block; margin-top:12px; font-weight:600; }
        input, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
        textarea { resize:vertical; min-height:70px; }
        button { margin-top:18px; width:100%; background:#4F46E5; color:white; border:none; padding:12px; border-radius:8px; font-size:15px; cursor:pointer; }
        button:hover { background:#4338CA; }
        .hidden { display:none; }
        .log { margin-top:20px; background:#0b1020; color:#9de1ff; padding:10px; border-radius:8px; font-size:12px; white-space:pre-wrap; }
    </style>
</head>
<body>
<div class="container">
    <h1>ALIKE í›„ì›í•˜ê¸°</h1>

    <div id="donationForm">
        <label>í›„ì›ì ì´ë¦„</label>
        <input id="donorName" placeholder="í™ê¸¸ë™"/>

        <label>ì´ë©”ì¼ (ì„ íƒ)</label>
        <input id="donorEmail" placeholder="gildong@example.com"/>

        <label>í›„ì› ë©”ì‹œì§€ (ì„ íƒ)</label>
        <textarea id="message" placeholder="í”„ë¡œì íŠ¸ ì‘ì›í•©ë‹ˆë‹¤!"></textarea>

        <label>í›„ì› ê¸ˆì•¡ (ì›)</label>
        <input id="amount" type="number" min="100" value="1000"/>

        <button id="donateBtn">í›„ì› ê²°ì œí•˜ê¸°</button>
    </div>

    <div id="confirmSection" class="hidden">
        <h3>ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ âœ…</h3>
        <p><strong>ê²°ì œ ìŠ¹ì¸í•˜ê¸°</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„œë²„ì— ê²°ì œ ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</p>
        <button id="confirmBtn">ê²°ì œ ìŠ¹ì¸í•˜ê¸°</button>
    </div>

    <div class="log" id="log"></div>
</div>

<script>
    const SERVER_URL = "http://localhost:8080"; // âœ… ì„œë²„ ì£¼ì†Œ
    const tossPayments = TossPayments("test_ck_P9BRQmyarYyEydLmDed7rJ07KzLN"); // âœ… í…ŒìŠ¤íŠ¸ ìœ„ì ¯ í‚¤

    const $ = (id) => document.getElementById(id);
    const log = (msg, data) => {
        $("log").textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n${data ? JSON.stringify(data,null,2):""}\n\n` + $("log").textContent;
    };

    $("donateBtn").addEventListener("click", async () => {
        try {
            const donorName = $("donorName").value.trim();
            const donorEmail = $("donorEmail").value.trim();
            const message = $("message").value.trim();
            const amount = parseInt($("amount").value);

            if (!donorName || !amount) {
                alert("í›„ì›ì ì´ë¦„ê³¼ ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return;
            }

            // 1ï¸âƒ£ ì„œë²„ì— í›„ì› ë°ì´í„° ì „ì†¡
            log("POST /v1/donations ìš”ì²­...");
            const donationRes = await fetch(`${SERVER_URL}/v1/donations`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ donorName, donorEmail, message, amount })
            });
            const donation = await donationRes.json();
            log("Donation ìƒì„± ì™„ë£Œ", donation);

            // 2ï¸âƒ£ Toss ê²°ì œì°½ ì—´ê¸°
            await tossPayments.requestPayment("ì¹´ë“œ", {
                amount: donation.amount,
                orderId: donation.donationId,
                orderName: `${donation.donorName}ë‹˜ì˜ í›„ì›`,
                successUrl: `${window.location.origin}/viewpoint/viewpoint.main/static/index.html?success=true`,
                failUrl: `${window.location.origin}/viewpoint/viewpoint.main/static/index.html?fail=true`
            });

        } catch (err) {
            log("ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜", err);
            alert("ê²°ì œ ìš”ì²­ ì‹¤íŒ¨: ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }
    });

    // 3ï¸âƒ£ í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° ê²€ì‚¬
    window.addEventListener("load", () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get("success") === "true") {
            log("ê²°ì œ ì„±ê³µ redirect ê°ì§€", Object.fromEntries(params));
            $("donationForm").classList.add("hidden");
            $("confirmSection").classList.remove("hidden");

            $("confirmBtn").onclick = async () => {
                const paymentKey = params.get("paymentKey");
                const orderId = params.get("orderId");
                const amount = params.get("amount");

                try {
                    const confirmRes = await fetch(`${SERVER_URL}/v1/payments/confirm`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ paymentKey, orderId, amount })
                    });
                    const data = await confirmRes.json();
                    log("ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ", data);
                    alert("ğŸ‰ ê²°ì œê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. í›„ì› ê°ì‚¬í•©ë‹ˆë‹¤!");
                } catch (e) {
                    log("ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨", e);
                    alert("ê²°ì œ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                }
            };
        } else if (params.get("fail") === "true") {
            log("ê²°ì œ ì‹¤íŒ¨", Object.fromEntries(params));
            alert("âŒ ê²°ì œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
</script>
</body>
</html>